# ============================================================================
# Configuración ADICIONAL de Telegraf para siscom-api
# ============================================================================
# INSTRUCCIONES:
# 1. AGREGAR este contenido a tu archivo telegraf.conf existente (NO reemplazar)
# 2. Mantén tu configuración actual intacta (puerto 8125 para otros proyectos)
# 3. Este bloque agrega soporte completo para siscom-api:
#    - Métricas StatsD en puerto 8126
#    - Logs desde Docker
# 4. Reinicia Telegraf: docker restart telegraf
# ============================================================================

# ====================
# Input: StatsD para siscom-api (Puerto 8126)
# ====================
# NOTA: Este es un input ADICIONAL que no interfiere con tu [[inputs.statsd]]
#       existente en el puerto 8125 para otros proyectos
[[inputs.statsd]]
  # Puerto DIFERENTE (8126) para siscom-api
  # Tus otros proyectos siguen usando 8125
  service_address = ":8126"
  protocol = "udp"
  
  # Configuración para aio-statsd (formato InfluxDB)
  # Diferente a tu config actual que usa datadog_extensions = true
  metric_separator = "."
  datadog_extensions = false        # aio-statsd usa formato InfluxDB, no Datadog
  
  # Percentiles para análisis de latencias
  percentiles = [50, 90, 95, 99]
  
  # Buffers (mismos valores que tu config actual)
  allowed_pending_messages = 10000
  percentile_limit = 1000
  
  # Retención de métricas
  delete_gauges = false
  delete_counters = false
  delete_sets = false
  delete_timings = true              # Convertir a estadísticas (mean, p95, etc.)
  
  # Tag para identificar estas métricas
  [inputs.statsd.tags]
    source = "siscom-api"

# ====================
# Input: Docker Logs de siscom-api
# ====================
# NOTA: Requiere que Telegraf tenga acceso a /var/run/docker.sock
#       Verifica tu docker-compose.yml:
#       volumes:
#         - /var/run/docker.sock:/var/run/docker.sock:ro
[[inputs.docker_log]]
  # Captura logs de stdout/stderr del contenedor siscom-api
  endpoint = "unix:///var/run/docker.sock"
  from_beginning = false  # Solo logs nuevos (no histórico)
  
  # Nombre del contenedor a monitorear
  container_name_include = ["siscom-api"]
  
  # Tags para identificar la fuente
  [inputs.docker_log.tags]
    source = "siscom-api"
    language = "python"
    framework = "fastapi"
    app = "siscom-api"

# ====================
# Procesador: Extraer nivel de log (INFO, ERROR, etc.)
# ====================
[[processors.regex]]
  order = 1
  namepass = ["docker_log"]  # Solo aplica a docker_log
  
  # Solo procesar logs de siscom-api
  [[processors.regex.tagpass]]
    source = ["siscom-api"]
  
  # Extraer log level como tag (facilita filtrado en Grafana)
  [[processors.regex.tags]]
    key = "message"
    pattern = '.*(INFO|ERROR|WARNING|DEBUG|CRITICAL).*'
    replacement = '${1}'
    result_key = "log_level"

# ============================================================================
# RESULTADO EN INFLUXDB
# ============================================================================
# Después de agregar esta configuración, tendrás:
#
# MÉTRICAS (measurement: statsd):
#   - siscom_api.requests (counter) → campo: count
#   - siscom_api.latency.stream (timer) → campos: mean, 95_percentile, etc.
#   - siscom_api.sse.active_connections (gauge) → campo: value
#   Tags: source=siscom-api
#
# LOGS (measurement: docker_log):
#   - message (string) → logs completos
#   Tags: source=siscom-api, log_level=INFO|ERROR|WARNING|DEBUG
# ============================================================================

# ============================================================================
# QUERIES DE EJEMPLO PARA GRAFANA
# ============================================================================
# Ver métricas de requests/min:
#   from(bucket: "siscom")
#     |> filter(fn: (r) => r._measurement == "siscom_api.requests")
#     |> aggregateWindow(every: 1m, fn: sum)
#     |> derivative(unit: 1m)
#
# Ver logs con errores:
#   from(bucket: "siscom")
#     |> filter(fn: (r) => r._measurement == "docker_log")
#     |> filter(fn: (r) => r.source == "siscom-api")
#     |> filter(fn: (r) => r.log_level == "ERROR")
# ============================================================================

# ============================================================================
# DOCUMENTACIÓN COMPLETA
# ============================================================================
# Para más información, consulta:
#   - docs/METRICS.md - Sistema de métricas completo
#   - docs/GRAFANA_QUERIES.md - Queries y dashboards
# ============================================================================
