# Configuración de Telegraf para recibir métricas StatsD de siscom-api
# y enviarlas a InfluxDB

# Plugin de entrada StatsD - Escucha métricas enviadas por la API
[[inputs.statsd]]
  # Puerto y protocolo para recibir métricas
  protocol = "udp"
  service_address = ":8125"
  
  # Eliminar el sufijo _bucket de las métricas de timing
  delete_gauges = false
  delete_counters = false
  delete_sets = false
  delete_timings = true
  
  # Percentiles a calcular para métricas de timing (latencia)
  percentiles = [50, 90, 95, 99]
  
  # Configuración de parsing
  metric_separator = "."
  
  # Configuración para parsear tags en formato InfluxDB
  # aio-statsd envía tags en el formato: metric,tag1=value1,tag2=value2:value|type
  parse_data_dog_tags = false
  
  # Permitir templates para extraer tags de los nombres de métricas
  allowed_pending_messages = 10000
  percentile_limit = 1000

# Plugin de salida para InfluxDB
[[outputs.influxdb_v2]]
  # URL de tu instancia de InfluxDB
  urls = ["http://influxdb:8086"]
  
  # Token de autenticación (configurar según tu instalación)
  token = "${INFLUX_TOKEN}"
  
  # Organización y bucket de destino
  organization = "${INFLUX_ORG}"
  bucket = "${INFLUX_BUCKET}"
  
  # Timeout de escritura
  timeout = "5s"

# Métricas generadas por siscom-api (usando aio-statsd):
#
# 1. siscom_api.requests (counter)
#    - Descripción: Número total de peticiones HTTP recibidas
#    - Tag: app=siscom-api
#    - Cálculo: Peticiones por minuto = rate(requests[1m])
#
# 2. siscom_api.latency.stream (timing)
#    - Descripción: Latencia del endpoint /stream en milisegundos
#    - Tag: app=siscom-api
#    - Métricas derivadas:
#      * siscom_api.latency.stream.mean (latencia media)
#      * siscom_api.latency.stream.median (percentil 50)
#      * siscom_api.latency.stream.p90 (percentil 90)
#      * siscom_api.latency.stream.p95 (percentil 95)
#      * siscom_api.latency.stream.p99 (percentil 99)
#
# 3. siscom_api.sse.active_connections (gauge/counter)
#    - Descripción: Número de conexiones SSE activas en este momento
#    - Tag: app=siscom-api

