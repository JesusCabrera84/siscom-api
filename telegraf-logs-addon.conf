# ====================================================================================
# Telegraf: Configuraci√≥n adicional para LOGS de siscom-api
# ====================================================================================
# Instrucciones:
#   1. Agrega este contenido a tu telegraf.conf existente
#   2. Aseg√∫rate que Telegraf tenga acceso a /var/run/docker.sock
#   3. Reinicia Telegraf: docker restart telegraf
# ====================================================================================

# ====================
# Input: Docker Logs de siscom-api (Python/FastAPI)
# ====================
[[inputs.docker_log]]
  # Captura logs de stdout/stderr del contenedor siscom-api
  endpoint = "unix:///var/run/docker.sock"
  from_beginning = false  # Solo logs nuevos (no hist√≥rico)
  
  # Nombre del contenedor a monitorear
  container_name_include = ["siscom-api"]
  
  # Tags para identificar la fuente
  [inputs.docker_log.tags]
    source = "siscom-api"
    language = "python"
    framework = "fastapi"
    app = "siscom-api"

# ====================
# Procesador: Extraer nivel de log (INFO, ERROR, etc.)
# ====================
[[processors.regex]]
  order = 1
  namepass = ["docker_log"]  # Solo aplica a docker_log
  
  # Solo procesar logs de siscom-api
  [[processors.regex.tagpass]]
    source = ["siscom-api"]
  
  # Extraer log level como tag (facilita filtrado en Grafana)
  [[processors.regex.tags]]
    key = "message"
    pattern = '.*(INFO|ERROR|WARNING|DEBUG|CRITICAL).*'
    replacement = '${1}'
    result_key = "log_level"

# ====================
# Procesador: Parsear estructura del log (OPCIONAL)
# ====================
# Descomenta si quieres parsear el log en campos separados
# [[processors.regex]]
#   order = 2
#   namepass = ["docker_log"]
#   
#   [[processors.regex.tagpass]]
#     source = ["siscom-api"]
#   
#   [[processors.regex.fields]]
#     key = "message"
#     # Parsea: 2024-10-12 15:30:45 - app.core.middleware - INFO - üì® Request: GET /health
#     pattern = '^(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})\s+-\s+(\S+)\s+-\s+(INFO|ERROR|WARNING|DEBUG)\s+-\s+(.*)$'
#     result_key = "parsed"

# ====================================================================================
# IMPORTANTE: Verifica que tu docker-compose.yml de Telegraf tenga:
# ====================================================================================
# telegraf:
#   volumes:
#     - /var/run/docker.sock:/var/run/docker.sock:ro  # ‚ö†Ô∏è REQUERIDO
#     - ./telegraf.conf:/etc/telegraf/telegraf.conf:ro
# ====================================================================================

# ====================================================================================
# RESULTADO EN INFLUXDB
# ====================================================================================
# Measurement: docker_log
# Tags:
#   - source: siscom-api
#   - language: python
#   - framework: fastapi
#   - log_level: INFO|ERROR|WARNING|DEBUG
#   - container_name: siscom-api
#   - container_image: siscom-api:latest
# Fields:
#   - message: "2024-10-12 - INFO - üì® Request: GET /health"
#   - container_id: "abc123..."
# ====================================================================================

